# Energy Twin Prototype

A web-based simulation server for energy distribution grid modeling and village generation. This prototype provides an interactive environment for modeling electrical grid infrastructure with real-time simulation capabilities.

## Features

- **Village Generator**: Server-side procedural generation of villages with roads, houses, and infrastructure
- **Distribution Grid Overlay**: Server-side electrical grid modeling and analysis
- **Interactive Client**: Clickable adjustable objects with real-time updates
- **Simulation Loop**: Server-side simulation with WebSocket snapshots
- **Load Auras**: Visual representation of electrical load around grid poles

## Prerequisites

- **Python 3.9+**: Required for FastAPI and modern Python features
- **pip**: Python package installer (usually comes with Python)
- **Terminal/Command Line**: For running commands

## Installation & Setup

### 1. Navigate to the server directory

```bash
cd server
```

### 2. Create virtual environment (if not already created)

```bash
python3 -m venv venv
```

### 3. Activate virtual environment

**On macOS/Linux:**
```bash
source venv/bin/activate
```

**On Windows:**
```bash
venv\Scripts\activate
```

### 4. Install dependencies

```bash
pip install -r requirements.txt
```

This will install:
- `fastapi>=0.110` - Web framework
- `uvicorn[standard]>=0.29` - ASGI server
- `numpy>=1.24` - Numerical computing

### 5. Start the server

```bash
python app.py
```

The server will start on `http://localhost:8000` with auto-reload enabled for development.

## Project Structure

```
energy_twin_proto/
├── README.md
├── client/                     # Frontend web interface
│   ├── index.html             # Main client page
│   └── src/                   # Client-side JavaScript
│       ├── api.js             # API communication utilities
│       └── app.js             # Main client application
└── server/                    # Backend simulation server
    ├── app.py                 # Main FastAPI application
    ├── requirements.txt       # Python dependencies
    ├── api/                   # API route handlers
    │   ├── routes_geo.py      # Geographic data endpoints
    │   ├── routes_grid.py     # Grid management endpoints
    │   └── routes_sim.py      # Simulation control endpoints
    ├── contexts/              # Business logic modules
    │   ├── geo_village/       # Village generation context
    │   │   ├── domain/        # Core models and entities
    │   │   ├── infrastructure/# Implementation details
    │   │   ├── interface/     # CLI interface
    │   │   └── use_cases/     # Business use cases
    │   └── power_grid/        # Power grid context
    │       ├── domain/        # Grid models and entities
    │       ├── infrastructure/# Grid implementation
    │       └── use_cases/     # Grid operations
    ├── persistence/           # Data persistence layer
    ├── schemas/               # API schemas
    └── services/              # Shared services
```

## Accessing the Application

### Web Interface
Open your browser and navigate to:
```
http://localhost:8000
```

### API Documentation
Interactive API documentation is automatically generated by FastAPI:
```
http://localhost:8000/docs
```

Alternative documentation format:
```
http://localhost:8000/redoc
```

## Available API Endpoints

### Geographic Data (`/geo`)

#### Generate Village
- **POST** `/geo/generate`
- Generate a new village with randomized elements
- Parameters:
  - `seed` (int): Random seed for reproducible generation
  - `width` (int): Village width in units
  - `height` (int): Village height in units
  - `tags` (str): Comma-separated tags for customization

#### Get Geographic Data
- **GET** `/geo/{geo_id}`
- Retrieve generated village data by ID

### Grid Management (`/grid`)

#### Build Grid from Geography
- **POST** `/grid/build_from_geo`
- Create electrical grid based on generated village
- Parameters:
  - `geo_id` (str): ID of the geographic data to base grid on

#### Get Grid
- **GET** `/grid/{grid_id}`
- Retrieve grid configuration by ID

#### Grid Commands
- **PATCH** `/grid/{grid_id}/command`
- Modify grid components
- Command types:
  - `update_props`: Update node properties
  - `add_source`: Add power source
  - `add_pole`: Add distribution pole
  - `connect_line`: Connect two nodes with transmission line

### Simulation (`/sim`)

#### Start Simulation
- **POST** `/sim/start`
- Begin real-time grid simulation
- Parameters:
  - `grid_id` (str): Grid to simulate
  - `dt` (float): Time step in seconds (default: 1.0)

#### Pause Simulation
- **POST** `/sim/pause`
- Pause the current simulation

#### Step Simulation
- **POST** `/sim/step`
- Advance simulation by specified steps
- Parameters:
  - `n` (int): Number of steps to advance

#### Get Simulation State
- **GET** `/sim/state`
- Retrieve current simulation status

#### WebSocket Stream
- **WebSocket** `/sim/stream`
- Real-time simulation updates via WebSocket

## Usage Example

### 1. Generate a Village
```bash
curl -X POST "http://localhost:8000/geo/generate" \
     -G -d "seed=123" \
     -d "width=300" \
     -d "height=300"
```

### 2. Build Grid from Village
```bash
curl -X POST "http://localhost:8000/grid/build_from_geo" \
     -H "Content-Type: application/json" \
     -d '{"geo_id": "your_geo_id_here"}'
```

### 3. Start Simulation
```bash
curl -X POST "http://localhost:8000/sim/start" \
     -H "Content-Type: application/json" \
     -d '{"grid_id": "your_grid_id_here", "dt": 1.0}'
```

## Troubleshooting

### Server Won't Start

**Problem**: Port 8000 already in use
```bash
# Kill process using port 8000
lsof -ti:8000 | xargs kill -9

# Or start server on different port
uvicorn app:app --host 0.0.0.0 --port 8001
```

**Problem**: Python version issues
```bash
# Check Python version
python3 --version

# Ensure Python 3.9+ is installed and being used
which python3
```

### Dependencies Issues

**Problem**: Installation fails
```bash
# Upgrade pip first
pip install --upgrade pip

# Install with verbose output
pip install -r requirements.txt -v
```

**Problem**: Virtual environment not working
```bash
# Deactivate and recreate virtual environment
deactivate
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### API Access Issues

**Problem**: Cannot access API documentation
- Ensure server is running on `http://localhost:8000`
- Check browser console for CORS errors
- Verify FastAPI is properly installed

**Problem**: WebSocket connection fails
- Check browser console for connection errors
- Ensure simulation endpoints are properly configured
- Verify WebSocket endpoint `/sim/stream` is accessible

### Performance Issues

**Problem**: Slow simulation performance
- Reduce simulation time step (`dt` parameter)
- Limit village size for generation
- Check system resources (CPU/memory usage)

## Development Notes

- The server includes auto-reload for development (restart on code changes)
- CORS is enabled for all origins (`*`) for development convenience
- Grid and geographic data are stored in-memory (no database required)
- WebSocket connections automatically clean up on disconnect
- Static files are served from the `../client` directory

## Next Steps

1. **Explore the API**: Use the interactive documentation at `/docs`
2. **Generate Villages**: Create different village configurations
3. **Build Grids**: Convert geographic data into electrical grids
4. **Run Simulations**: Start, pause, and step through simulations
5. **Monitor Performance**: Watch real-time updates via WebSocket
6. **Customize Parameters**: Experiment with different simulation parameters

For additional help or to report issues, refer to the API documentation or examine the source code in the `server/` directory.
